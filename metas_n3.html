<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Indicadores N3 - Filtro por M√™s e Ano</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f2f2f2;
  }

  /* Cabe√ßalho no padr√£o BIZA */
  .topo {
    background: #000000;
    padding: 25px;
    text-align: center;
  }

  .topo h1 {
    margin: 0;
    color: #F8AD1E; /* Laranja GHT */
    font-size: 32px;
    font-weight: bold;
  }

  /* √Årea de filtros */
 .filtros {
    padding: 20px 30px;
    display: flex;
    flex-wrap: wrap;      /* quebra linha no mobile se faltar espa√ßo */
    gap: 10px;            /* espa√ßo entre os elementos */
    align-items: center;  /* alinha tudo na mesma altura */
}

  label {
    font-weight: bold;
    margin-right: 8px;
  }

  select {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-right: 15px;
    font-size: 15px;
  }

  button {
    padding: 10px 18px;
    border-radius: 6px;
    border: none;
    background: #F8AD1E;
    color: black;
    font-weight: bold;
    cursor: pointer;
  }

  button:hover {
    background: #e19b16;
  }

  /* Tabela */
/* Container geral centralizado e responsivo */
.container-tabelas {
    width: 100%;
    max-width: 1250px;   /* TAMANHO PADR√ÉO DE TODAS AS TABELAS */
    margin: 0 auto;      /* Centraliza tudo */
    padding-bottom: 40px;
}

/* Mant√©m as tabelas alinhadas */
table {
    width: 100% !important;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    margin: 20px auto;
}

/* s√≥ a tabela principal come√ßa escondida */
#tabelaResultado {
    display: none;
}

/* Rolagem horizontal no mobile */
@media (max-width: 900px) {
    .container-tabelas {
        padding: 0 10px;
        overflow-x: auto;
    }

    table {
        min-width: 900px; /* Mant√©m formato mesmo no celular */
    }
}


  th {
    background: #444; 
    color: white;
    font-size: 14px;
    padding: 10px;
    text-align: left;
  }

  td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
  }

  tr:nth-child(even) {
    background: #f9f9f9;
  }

  tr:hover {
    background: #f1f1f1;
  }

  /* Tabela interna dos cards */
.card-table {
    width: 100% !important;
    table-layout: fixed !important;  /* üî• PADRONIZA O TAMANHO DAS COLUNAS */
    border-collapse: collapse;
}

/* Padroniza os cabe√ßalhos das tabelas */
.card-table th {
    width: auto;
    text-align: left;
    background: #000000;
    color: #F9BD45;
    padding: 10px;
    font-size: 14px;
    font-weight: bold;
}

/* Padroniza as c√©lulas */
.card-table td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    word-wrap: break-word; /* üî• impede quebra feia */
}

/* Centralizar todas as tabelas internas */
.card-wrapper {
    width: 100%;
    max-width: 1250px;   /* üî• MESMO PADR√ÉO PARA TODAS */
    margin: 0 auto;
}
.btn-voltar {
    background: #F8AD1E;
    color: black;
    font-weight: bold;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
    /* tiramos margin-left grande */
}

.btn-voltar:hover {
    background: #e19b16;
}

.btn-toggle-all {
    background: #000;
    color: #F8AD1E;
    font-weight: bold;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
}

.btn-toggle-all:hover {
    background: #222;
}

</style>

</head>
<body>

<div class="topo">
  <h1>Filtro de Indicadores N3</h1>
</div>

<div class="filtros">
  <label>M√™s:</label>
  <select id="filtroMes"></select>

  <label>Ano:</label>
  <select id="filtroAno"></select>

    <!-- bot√£o filtrAR removido <button onclick="filtrar()">Filtrar</button> -->

  <button class="btn-voltar" onclick="window.location.href='index.html'">
    ‚¨Ö Voltar
</button>

<button class="btn-toggle-all" onclick="toggleTodos()">
    Expandir / Recolher Todos
</button>

</div>

<div class="container-tabelas">
    <table id="tabelaResultado">
        <thead id="cabecalho"></thead>
        <tbody id="corpoTabela"></tbody>
    </table>
</div>

<script>
// Caminho do CSV direto do GitHub
const CSV_URL = "https://raw.githubusercontent.com/SGIBIZA/Painel-de-Metas-BIZA/main/base_n3.csv";

// Vari√°veis globais
let dadosCSV = [];
let cabecalhos = [];

document.addEventListener("DOMContentLoaded", () => {
  carregarCSV();

  const filtroMes = document.getElementById("filtroMes");
  const filtroAno = document.getElementById("filtroAno");

  function aoMudarFiltro() {
    const mes = filtroMes.value;
    const ano = filtroAno.value;

    // s√≥ filtra se os DOIS estiverem preenchidos
    if (mes && ano) {
      filtrar();
    }
  }

  filtroMes.addEventListener("change", aoMudarFiltro);
  filtroAno.addEventListener("change", aoMudarFiltro);
});

// -----------------------------
// 1) Carregar CSV do GitHub
// -----------------------------
function carregarCSV() {
  fetch(CSV_URL)
    .then(resp => resp.text())
    .then(texto => {
      processarCSV(texto);
      preencherFiltros();
    })
    .catch(err => console.error("Erro ao carregar CSV:", err));
}

// -----------------------------
// 2) Processar CSV
// -----------------------------
function processarCSV(texto) {
  const linhas = texto.split("\n").map(l => l.trim()).filter(l => l);

  // Remove BOM
  let header = linhas[0].replace(/^\uFEFF/, '').split(";");

  // Normaliza√ß√£o dos nomes das colunas
  cabecalhos = header.map(c =>
    c.normalize("NFD")
     .replace(/[\u0300-\u036f]/g, "") // remove acentos
     .replace(/[^a-zA-Z0-9 ]/g, "")   // remove caracteres ÔøΩ e outros
     .trim()
  );

  linhas.shift(); // remove a linha do cabe√ßalho

  dadosCSV = linhas.map(linha => {
    const colunas = linha.split(";");
    const item = {};

    cabecalhos.forEach((c, i) => {
      item[c] = colunas[i] || "";
    });

    return item;
  });
}

// -----------------------------
// 3) Criar filtros de M√™s e Ano
// -----------------------------
function preencherFiltros() {
  const filtroMes = document.getElementById("filtroMes");
  const filtroAno = document.getElementById("filtroAno");

  let meses = new Set();
  let anos = new Set();

  // Descobre quais s√£o as colunas de "M√™s texto" e "Ano"
  const mesKey = cabecalhos.find(c =>
    c.toLowerCase().includes("m√™s texto") || c.toLowerCase().includes("mes texto")
  );
  const anoKey = cabecalhos.find(c =>
    c.toLowerCase().trim() === "ano"
  );

  dadosCSV.forEach(item => {
    meses.add(item[mesKey]);
    anos.add(item[anoKey]);
  });

  filtroMes.innerHTML = "<option value=''>Selecione</option>";
  filtroAno.innerHTML = "<option value=''>Selecione</option>";

  meses.forEach(m => filtroMes.innerHTML += `<option value="${m}">${m}</option>`);
  anos.forEach(a => filtroAno.innerHTML += `<option value="${a}">${a}</option>`);

  // üîπ DEFINIR M√äS ANTERIOR E ANO ATUAL AO ABRIR O SITE
  const hoje = new Date();
  let mesAnterior = hoje.getMonth() - 1; // 0 = Janeiro
  let anoAtual = hoje.getFullYear();

  if (mesAnterior < 0) {
    mesAnterior = 11;       // Dezembro
    anoAtual -= 1;
  }

  const nomesMeses = [
    "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
    "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
  ];
  const mesAnteriorTexto = nomesMeses[mesAnterior];

  // Tenta aplicar os valores padr√£o (s√≥ se existirem nas op√ß√µes)
  if ([...filtroMes.options].some(o => o.value === mesAnteriorTexto)) {
    filtroMes.value = mesAnteriorTexto;
  }
  if ([...filtroAno.options].some(o => o.value === String(anoAtual))) {
    filtroAno.value = String(anoAtual);
  }

  // üîπ J√Å CHAMA O FILTRAR UMA VEZ AO CARREGAR A P√ÅGINA
  if (filtroMes.value && filtroAno.value) {
    filtrar();
  }
}

// -----------------------------
// 4) Essa fun√ß√£o interpreta o texto e devolve a cor certa
// -----------------------------

function gerarBadgeStatus(status) {
    const s = status.toLowerCase().trim();

    // status normalizado
    if (s.includes("atingido") && !s.includes("n√£o") && !s.includes("nao") && !s.includes("√±")) {
        return `<div style="display:flex; align-items:center; gap:6px;">
                    <div style="width:14px; height:14px; background:#00B050; border-radius:50%;"></div>
                    <span style="font-weight:bold;">Atingido</span>
                </div>`;
    }

    if (s.includes("n√£o") || s.includes("nao") || s.includes("√±")) {
        return `<div style="display:flex; align-items:center; gap:6px;">
                    <div style="width:14px; height:14px; background:#FF0101; border-radius:50%;"></div>
                    <span style="font-weight:bold;">N√£o Atingido</span>
                </div>`;
    }

    // indefinido = amarelo
    return `<div style="display:flex; align-items:center; gap:6px;">
                <div style="width:14px; height:14px; background:#EEEE00; border-radius:50%;"></div>
                <span style="font-weight:bold;">Indefinido</span>
            </div>`;
}

// Criar fun√ß√£o auxiliar que devolve a cor do STATUS

function corDoStatus(status) {
    const s = status.toLowerCase().trim();

    if (s.includes("atingido") && !s.includes("n√£o") && !s.includes("nao") && !s.includes("√±")) {
        return "#00B050"; // verde
    }
    if (s.includes("n√£o") || s.includes("nao") || s.includes("√±")) {
        return "#FF0101"; // vermelho
    }
    
    return "#FFC000"; // indefinido = amarelo
}

// ==========================================================
//  LISTAS DE INDICADORES COM FORMATA√á√ÉO CONTROLADA
// ==========================================================

// Normaliza texto para compara√ß√£o correta
function normalizar(txt) {
    return txt
        ?.normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-zA-Z0-9 ]/g, "")
        .toLowerCase()
        .trim();
}

const LISTA_A_PERCENTUAL = [
  "√çndice de Garantia procedente BIZA",
  "Refugo‚Äã Interno",
  "Percentual e Valores de Itens sem movimenta√ß√£o de Estoque a mais de um ano‚Äã‚Äã‚Äã",
  "Absente√≠smo M√™s",
  "Percentual de Turnover M√™s‚Äã",
  "Percentual de Itens Novos Produzidos no M√™s‚Äã",
  "Percentual de vendas marca BIZA",
  "Quantidade e percentual de NC's encerradas dentro do prazo",
  "Performance de entregas BIZA (Pedidos entregues no prazo)‚Äã",
  "Programa√ß√£o de entrega Mensal‚Äã",
  "Acuracidade de Estoque",
  "Performance do Atendimento √†s Obriga√ß√µes Legais M√™s",
  "GGF Salarial - Relat√≥rio Entradas de NF"
].map(normalizar);

const LISTA_B_FINANCEIRO = [
  "Valor de Produ√ß√£o Mensal",
  "Valores de venda Marca BIZA",
  "Valor de Produ√ß√£o Acumulado",
  "Valor total de itens terceiriza√ß√£o por m√™s",
  "Valor total de itens industrializados por m√™s‚Äã",
  "Valor em estoque BIZA estratificado",
  "Vendas Marca Biza (√öltimos 3 anos)",
  "Valores de Pedidos em Carteira"
].map(normalizar);

const LISTA_C_META_PERCENTUAL = [
  "√çndice de Garantia procedente BIZA",
  "Refugo‚Äã Interno",
  "Percentual e Valores de Itens sem movimenta√ß√£o de Estoque a mais de um ano‚Äã‚Äã‚Äã",
  "Absente√≠smo M√™s",
  "Percentual de Turnover M√™s‚Äã",
  "Percentual de Itens Novos Produzidos no M√™s‚Äã",
  "Percentual de vendas marca BIZA",
  "Quantidade e percentual de NC's encerradas dentro do prazo",
  "Performance de entregas BIZA (Pedidos entregues no prazo)‚Äã",
  "Programa√ß√£o de entrega Mensal‚Äã",
  "Acuracidade de Estoque",
  "Performance do Atendimento √†s Obriga√ß√µes Legais M√™s",
  "GGF Salarial - Relat√≥rio Entradas de NF"
].map(normalizar);

// ==========================================================
//  FORMATADORES ESPEC√çFICOS
// ==========================================================

// -- formatar % --
function formatarPercentual(valor) {
    if (!valor) return valor;
    if (valor.includes("%")) return valor;

    let num = parseFloat(valor.replace(",", "."));
    if (isNaN(num)) return valor;

    // se vier 1.05 ‚Üí 105%
    if (num <= 3) num = num * 100;

    return num.toFixed(2).replace(".", ",") + "%";
}

// -- formatar financeiro --
function formatarFinanceiro(valor) {
    if (!valor) return valor;
    let num = parseFloat(valor.replace(",", "."));
    if (isNaN(num)) return valor;

    if (num >= 1_000_000)
        return (num / 1_000_000).toFixed(2).replace(".", ",") + " mi";

    if (num >= 1000)
        return (num / 1000).toFixed(2).replace(".", ",") + " mil";

    return num.toString().replace(".", ",");
}

// ==========================================================
//  FUN√á√ÉO PRINCIPAL DE FORMATA√á√ÉO CONTROLADA
// ==========================================================

function formatarValor(indicador, coluna, valor) {
    if (!valor) return valor;
    if (!indicador) return valor;

    const indNorm = normalizar(indicador);
    const colNorm = coluna.toString().trim();

    // -----------------------------------------
    // LISTA A ‚Üí Resultado em %  (Resultado)
    // -----------------------------------------
    if (LISTA_A_PERCENTUAL.includes(indNorm) && colNorm === "Resultado") {
        return formatarPercentual(valor);
    }

    // LISTA A ‚Üí Meta tamb√©m em %  (Meta)
    if (LISTA_A_PERCENTUAL.includes(indNorm) && colNorm === "Meta") {
        return formatarPercentual(valor);
    }

    // -----------------------------------------
    // LISTA B ‚Üí Valores financeiros
    // (apenas Meta e Resultado)
    // -----------------------------------------
    if (LISTA_B_FINANCEIRO.includes(indNorm) &&
        (colNorm === "Meta" || colNorm === "Resultado")) {
        return formatarFinanceiro(valor);
    }

    // -----------------------------------------
    // LISTA C ‚Üí Meta em %  (Meta)
    // -----------------------------------------
    if (LISTA_C_META_PERCENTUAL.includes(indNorm) && colNorm === "Meta") {
        return formatarPercentual(valor);
    }

     // -----------------------------------------
    // NOVO: FORMATAR N√öMEROS INTEIROS PARA RESTANTE
    // -----------------------------------------
    let num = parseFloat(valor.replace(",", "."));
    if (!isNaN(num)) {
        return Math.round(num).toString(); // sem casas decimais
    }
    
    // -----------------------------------------
    // CASO PADR√ÉO: devolve o valor original
    // -----------------------------------------
    return valor;
}

// -----------------------------
// 5) Filtrar e montar a tabela
// -----------------------------
function filtrar() {
  const mes = document.getElementById("filtroMes").value;
  const ano = document.getElementById("filtroAno").value;
const indicadorKey = cabecalhos.find(c => c.toLowerCase().includes("indicador"));

  if (!mes || !ano) {
    alert("Selecione M√™s e Ano para filtrar.");
    return;
  }

  const tabela = document.getElementById("tabelaResultado");
  const cabeca = document.getElementById("cabecalho");
  const corpo  = document.getElementById("corpoTabela");

  // Descobre as colunas pelos nomes reais do CSV
  const mesKey = cabecalhos.find(c =>
    c.toLowerCase().includes("m√™s texto") || c.toLowerCase().includes("mes texto")
  );
  const anoKey = cabecalhos.find(c =>
    c.toLowerCase().trim() === "ano"
  );

  const areaKey = cabecalhos.find(c =>
    c.toLowerCase().startsWith("√°rea") || c.toLowerCase().startsWith("area")
  );
  const respKey = cabecalhos.find(c =>
    c.toLowerCase().startsWith("respons")
  );

  // Filtro
  const filtrados = dadosCSV.filter(item =>
    item[mesKey] === mes && item[anoKey] === ano
  );

  // Zera tabela principal
  cabeca.innerHTML = "";
  corpo.innerHTML  = "";

  // Remove "√Årea" e "Respons√°vel" da lista de colunas exibidas
  const colunasCard = cabecalhos.filter(c => c !== areaKey && c !== respKey);

  // Agrupamento por card
  const grupos = {};
  filtrados.forEach(item => {
    const chave = `${item[areaKey]} ‚Äì ${item[respKey]}`;
    if (!grupos[chave]) grupos[chave] = [];
    grupos[chave].push(item);
  });

  // Montagem dos cards
  Object.keys(grupos).forEach(grupoNome => {

    // üî∂ Linha de t√≠tulo do card
    const linhaGrupo = document.createElement("tr");
    linhaGrupo.innerHTML = `
      <td colspan="${colunasCard.length}"
          style="background:#333; color:#FFFFFF;
                 cursor:pointer; padding:12px;
                 font-size:20px; font-weight:bold;">
        ‚ñº ${grupoNome}
      </td>
    `;
    corpo.appendChild(linhaGrupo);

    // üî∑ Tabela interna do card
    const tabelaCard = document.createElement("table");
    tabelaCard.classList.add("card-table");
    tabelaCard.style.width = "100%";
    tabelaCard.style.marginBottom = "25px";
    tabelaCard.style.display = "none";   // üî• AGORA O CARD COME√áA FECHADO

    const thead = document.createElement("thead");
    const tbody = document.createElement("tbody");

    // Cabe√ßalho da tabela interna
    const headerRow = document.createElement("tr");
    headerRow.innerHTML = colunasCard
      .map(c => `<th>${c}</th>`)
      .join("");
    thead.appendChild(headerRow);

    // Linhas de dados
    grupos[grupoNome].forEach(item => {
      const linha = document.createElement("tr");

  linha.innerHTML = colunasCard.map(c => {
    let valor = item[c];

    // STATUS COM BOLINHA
    if (c.toLowerCase().includes("status")) {
        return `<td>${gerarBadgeStatus(valor)}</td>`;
    }

    // RESULTADO COLORIDO
    if (c.toLowerCase().includes("resultado")) {
        const statusKey = cabecalhos.find(x =>
            x.toLowerCase().includes("status")
        );
        const cor = corDoStatus(item[statusKey]);

        return `<td style="
            background:${cor};
            color:white;
            font-weight:bold;
            text-align:center;
            border-radius:4px;
        ">${formatarValor(item[indicadorKey], "Resultado", valor)
}</td>`;
    }

    // OUTRAS COLUNAS FORMATADAS
   return `<td>${formatarValor(item[indicadorKey], c, valor)
}</td>`;
}).join("");

      tbody.appendChild(linha);
    });

    tabelaCard.appendChild(thead);
    tabelaCard.appendChild(tbody);
    // Criar linha que vai conter a tabela interna
const linhaTabela = document.createElement("tr");
const tdTabela = document.createElement("td");

// Faz a tabela ocupar toda a largura do card
tdTabela.colSpan = colunasCard.length;

// Insere a tabela interna dentro do TD
tdTabela.appendChild(tabelaCard);

// Insere TD dentro do TR
linhaTabela.appendChild(tdTabela);

// Insere o TR dentro do corpo da tabela principal
corpo.appendChild(linhaTabela);

    // Toggle abre/fecha a tabela interna
    linhaGrupo.addEventListener("click", () => {
      tabelaCard.style.display =
        tabelaCard.style.display === "none" ? "" : "none";
    });
  });

  tabela.style.display = "table";
}
function toggleTodos() {
    // Seleciona todas as tabelas internas dos cards
    const todasTabelas = document.querySelectorAll(".card-table");

    let temAlgumaAberta = false;

    // Verifica se existe pelo menos uma aberta
    todasTabelas.forEach(t => {
        if (t.style.display !== "none") temAlgumaAberta = true;
    });

    // Se existe aberta ‚Üí fecha todas
    // Se todas fechadas ‚Üí abre todas
    todasTabelas.forEach(t => {
        t.style.display = temAlgumaAberta ? "none" : "";
    });
}

</script>

</body>
</html>